name: Publish to PyPI

on:
  push:
    tags:
      - 'v*'  # æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0, v2.1.3
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: read
  id-token: write  # è¿™æ˜¯OIDCçš„å…³é”®æƒé™ï¼Œç”¨äºTrusted Publisher

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build package
      run: python -m build

    - name: Check package
      run: twine check dist/*

    - name: Publish to PyPI (Trusted Publisher)
      id: trusted-publish
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        print-hash: true
      continue-on-error: true

    - name: Check Trusted Publisher result
      if: steps.trusted-publish.outcome == 'failure'
      run: |
        echo "âš ï¸  Trusted Publisher å‘å¸ƒå¤±è´¥"
        echo "ğŸ“‹ è§£å†³æ–¹æ³•ï¼š"
        echo "   1. è®¿é—®: https://pypi.org/manage/project/mddocx/settings/publishing/"
        echo "   2. æ·»åŠ  Trusted Publisher:"
        echo "      - Publisher: GitHub"
        echo "      - Repository: wangqiqi/md2docx"
        echo "      - Workflow: publish.yml"
        echo "      - Environment: (ç•™ç©º)"
        echo "   3. æˆ–ä½¿ç”¨æ‰‹åŠ¨å‘å¸ƒ: ./scripts/publish_to_pypi.sh"
        echo ""
        echo "ğŸ” å½“å‰ claims ä¿¡æ¯:"
        echo "   sub: repo:wangqiqi/md2docx:ref:refs/tags/${GITHUB_REF#refs/tags/}"
        echo "   repository: wangqiqi/md2docx"
        echo "   repository_owner: wangqiqi"
        echo "   workflow_ref: wangqiqi/md2docx/.github/workflows/publish.yml@refs/tags/${GITHUB_REF#refs/tags/}"
        exit 1
